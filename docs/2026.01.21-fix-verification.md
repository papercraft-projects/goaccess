# GoAccess SIGSEGV 크래시 수정 및 검증 결과

## 개요

- **날짜**: 2026-01-21
- **이슈**: GoAccess 1.9.4 Sig 11 (SIGSEGV) 크래시
- **크래시 지점**: `/logs/custom_vhost_access.log` Line 4449
- **상태**: ✅ 해결됨

---

## 원인 분석

### 크래시 로그
```
==1== GoAccess 1.9.4 crashed by Sig 11
==1== FILE: /logs/custom_vhost_access.log
==1== Line number: 4449
==1== Invalid data: 0
==1== Piping: 0
```

### 문제 로그 라인 (4449)
```
biz.hanbat.ac.kr:443 220.123.66.49 - - [21/Jan/2026:15:52:48 +0900] "GET / HTTP/1.1" 301 166 "-" "FlowKat/5.0.27"
```

### 식별된 문제점
1. `parser.c`의 `handle_default_case_token` 함수에서 NULL 포인터 체크 부재
2. FlowKat User-Agent가 크롤러/업타임 체커 목록에 미등록

---

## 적용된 수정사항

### 1. parser.c - NULL 포인터 체크 강화

**파일**: `src/parser.c`
**커밋**: `d84c16b8`

```c
static int
handle_default_case_token (const char **str, const char *p) {
  char *pch = NULL;

  // NULL 체크 추가
  if (p == NULL || p[0] == '\0' || p[1] == '\0') {
    return 0;
  }
  // ...
}
```

### 2. browsers.c - FlowKat User-Agent 등록

**파일**: `src/browsers.c`
**위치**: Line 342-343

```c
{"CloudFlare-AlwaysOnline", "Uptime"},
{"FlowKat", "Uptime"},  // 추가됨
```

**효과**: `--ignore-crawlers` 옵션 사용 시 FlowKat 요청 자동 제외

---

## 검증 결과

### 빌드 테스트
| 항목 | 결과 |
|------|------|
| Docker 빌드 | ✅ 성공 |
| 이미지 이름 | `goaccess-flowkat` |
| 빌드 스크립트 | `build_docker.sh` |

### 크래시 테스트
| 항목 | 이전 | 이후 |
|------|------|------|
| Line 4449 파싱 | ❌ SIGSEGV | ✅ 정상 |
| 전체 파싱 | 실패 | ✅ 완료 |

### FlowKat 제외 테스트
| 리포트 | 크기 | 옵션 |
|--------|------|------|
| `test_flowkat.html` | 903 KB | 기본 |
| `test_no_crawlers.html` | 869 KB | `--ignore-crawlers` |
| **차이** | **-34 KB** | FlowKat 요청 제외됨 |

---

## 사용 방법

### 기본 실행
```bash
docker run --rm -v /logs:/logs goaccess-flowkat \
  /logs/access.log \
  --log-format=VCOMBINED
```

### FlowKat 제외 (권장)
```bash
docker run --rm -v /logs:/logs goaccess-flowkat \
  /logs/access.log \
  --log-format=VCOMBINED \
  --ignore-crawlers
```

### HTML 리포트 생성
```bash
docker run --rm \
  -v /logs:/logs \
  -v /output:/output \
  goaccess-flowkat \
  /logs/access.log \
  --log-format=VCOMBINED \
  --ignore-crawlers \
  -o /output/report.html
```

---

## 관련 파일

- `src/parser.c` - 파싱 로직 및 NULL 체크
- `src/browsers.c` - User-Agent 분류
- `src/gholder.c` - VIRTUAL_HOSTS 패널 처리
- `src/gstorage.c` - vhost 키 생성
- `build_docker.sh` - Docker 빌드 스크립트
- `run_flowkat.sh` - 실행 스크립트

---

## 결론

1. **크래시 원인**: `handle_default_case_token` 함수의 NULL 포인터 참조
2. **해결 방법**: NULL 체크 강화 및 FlowKat User-Agent 등록
3. **검증 완료**: 4449 라인 포함 전체 로그 정상 파싱
4. **추가 기능**: `--ignore-crawlers` 옵션으로 헬스체크 요청 제외 가능
